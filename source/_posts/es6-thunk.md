---
title: ã€å­¦ä¹ ç¬”è®°ã€‘Thunk å‡½æ•°
date: 2018-10-19 16:28:43
tags: ['javascript', 'generator']
---

> æ¯æ—¥ä¸€è¨€ï¼šç»…å£«å°±æ˜¯æ‰€åšçš„ä¸æ˜¯è‡ªå·±æƒ³åšä¹‹äº‹ï¼Œè€Œæ˜¯è‡ªå·±åº”åšä¹‹äº‹ - æ‘ä¸Šæ˜¥æ ‘

ä»é˜®ä¸€å³°çš„ã€ŠES6 æ ‡å‡†å…¥é—¨ã€‹äº†è§£åˆ° Thunk å‡½æ•°çš„æ¦‚å¿µï¼Œä¸ºä»€ä¹ˆç™¾åº¦ç¿»è¯‘ Thunk æ˜¯ è‡€éƒ¨ ğŸ˜“ ã€‚

## èƒŒæ™¯

### ä¸¾ä¸ª ğŸŒ°

```js
var x = 1;
function f(m) {
    return m * 2;
}

f(x + 5);
```

ç¼–ç¨‹è¯­è¨€å¯¹äºä¸Šè¿°ç¨‹åºçš„æ±‚å€¼ç­–ç•¥æœ‰ä¸¤ç§æ„è§ï¼Œå³ã€ä¼ å€¼ç­–ç•¥ï¼ˆcall by valueï¼‰ã€å’Œã€ä¼ åè°ƒç”¨ï¼ˆcall by nameï¼‰ã€ã€‚

- ä¼ å€¼è°ƒç”¨ï¼šå…ˆè®¡ç®—å‡º x + 5(=6)ï¼Œ å†è°ƒç”¨ f(6)
    - ä¼˜ç‚¹ï¼šç®€å•
    - ç¼ºç‚¹ï¼šæŸäº›å‚æ•°æ²¡ç”¨åˆ°å°±è®¡ç®—ï¼Œä¼šé€ æˆæ€§èƒ½æŸå¤±
- ä¼ åè°ƒç”¨ï¼šç›´æ¥å°†è¡¨è¾¾å¼ x + 5 ä¼ å…¥å‡½æ•°ä½“ï¼Œå³ (x + 5) * 2

## å«ä¹‰

> ã€æ‘˜è‡ªé˜®ä¸€å³°çš„ã€ŠES6 æ ‡å‡†å…¥é—¨ã€‹ã€‘ç¼–è¯‘å™¨çš„â€œä¼ åè°ƒç”¨â€çš„å®ç°å¾€å¾€æ˜¯å°†å‚æ•°æ”¾åˆ°ä¸€ä¸ªä¸´æ—¶å‡½æ•°ä¹‹ä¸­ï¼Œå†å°†è¿™ä¸ªä¸´æ—¶å‡½æ•°ä¼ å…¥å‡½æ•°ä½“ã€‚è¿™ä¸ªä¸´æ—¶å‡½æ•°å°±æˆä¸º Thunk å‡½æ•°ã€‚

### Javascript çš„ Thunk å‡½æ•°

> JS è¯­éŸ³æ˜¯ä¼ å€¼è°ƒç”¨ï¼Œæ‰€ä»¥åœ¨ JS ä¸­ï¼ŒThunk å‡½æ•°æ›¿æ¢çš„ä¸æ˜¯è¡¨è¾¾å¼ï¼Œè€Œæ˜¯å¤šå‚æ•°å‡½æ•°ï¼Œå°†å…¶æ›¿æ¢æˆä¸€ä¸ªåªæ¥å—æ¯æ‰å‡½æ•°ä½œä¸ºå‚æ•°çš„å•å‚æ•°å‡½æ•°ï¼Œå¦‚ä¸‹ä¾‹ï¼š

```
f(a, cb);

var Thunk = function (a) {
    return function (cb) {
        return f(a, cb); 
    };
};

var ex = Thunk(a);
ex(cb);
```

å¯ä»¥çœ‹å‡ºï¼Œå¯¹äºä¸€ä¸ªæœ‰å¤šä¸ªå‚æ•°çš„å‡½æ•°ï¼ˆæœ‰ä¸€ä¸ªå‚æ•°æ˜¯æ¯æ‰å‡½æ•°ï¼‰ï¼ŒThunk å‡½æ•°çš„ä½œç”¨å°±æ˜¯å°†å…¶è½¬æ¢æˆä¸€ä¸ªåªæ¥æ”¶å›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°çš„å•å‚æ•°å‡½æ•°ã€‚

## thunkify æ¨¡å—

> æºç ï¼šhttps://github.com/tj/node-thunkify
> npmjsï¼šhttps://www.npmjs.com/package/thunkify

thunkify æ˜¯ä¸€ä¸ªå¯ä»¥ç›´æ¥æ‹¿è¿‡æ¥ç”¨çš„å°è£…å¥½çš„ Thunk å‡½æ•°ï¼Œæºç å¾ˆç®€å•ï¼Œé™åˆ¶äº†å›è°ƒå‡½æ•°åªå…è®¸æ‰§è¡Œä¸€æ¬¡ã€‚å’Œ co ä¸€æ ·æ˜¯ tj å¼€å‘çš„ï¼Œå¥½å§ï¼Œtjå·²ç»æ˜¯æˆ‘å¶åƒäº†ã€‚

## ä½œç”¨

ä¹¦ä¸­è®²ï¼Œä»¥å‰æ˜¯æ²¡ä»€ä¹ˆç”¨çš„ï¼Œå› ä¸ºæ²¡æœ‰ä»€ä¹ˆä½¿ç”¨åœºæ™¯ï¼Œä½†æ˜¯ ES6 ä¸­æœ‰äº† Generator å‡½æ•°ä¹‹åï¼Œ Thunk å‡½æ•°å°±å¯ä»¥ç”¨äº Generator å‡½æ•°çš„è‡ªåŠ¨æµç¨‹ç®¡ç†ã€‚

### ä¸¾ä¸ª ğŸŒ°

```js
function* gen() {
    // ...
}

var g = gen();
var res = g.next();

while(!res.done) {
    console.log(res.value);
    res = g.next();
}
```

ä¸Šè¿°æƒ…å†µä¸‹ï¼Œwhile å¾ªç¯ä¼šä¸€ç›´è‡ªåŠ¨æ‰§è¡Œ gen.next ç›´åˆ°å®Œæˆæ‰€æœ‰çš„æ­¥éª¤ã€‚è¿™æ ·æœ‰ä¸€ä¸ªç¼ºç‚¹æ˜¯ï¼Œåœ¨å¼‚æ­¥ä¸‹ï¼Œéœ€è¦ç­‰å‰ä¸€ä¸ªå¼‚æ­¥æ“ä½œæ‰§è¡Œå®Œä¹‹åå†ç»§ç»­æ‰§è¡Œã€‚æ­¤æ—¶ï¼Œå°±éœ€è¦å€ŸåŠ© Thunk å‡½æ•°ã€‚ä¸¾ä¸€ä¸ªä¹¦ä¸­çš„æ —å­ï¼š

```js
/* ä»¥è¯»å–æ–‡ä»¶ä¸ºä¾‹ */

var fs = require('fs');
var thunkify = require('thunkify');
var readFileThunk = thunkify(fs.readFile);

var gen = function* () {
    var r1 = yeild readFileThunk('/etc/fstab');
    console.log(r1.toString());
    var r2 = yeild readFileThunk('/etc/shells');
    console.log(r2.toString());
};
```
ä¼—æ‰€å‘¨çŸ¥ï¼ŒGenerator å‡½æ•°ä¸­çš„ yeild æ˜¯äº¤å‡º Generator å‡½æ•°çš„æ‰§è¡Œæƒï¼Œå³å»æ‰§è¡Œå¼‚æ­¥å‡½æ•°ï¼Œè€Œ yeild åé¢è·Ÿçš„ Thunk å‡½æ•°å¯ä»¥åœ¨å›è°ƒå‡½æ•°ä¸­ï¼Œå°†æ‰§è¡Œæƒé‡æ–°äº¤ç»™ Generatorã€‚

æ­¤æ—¶ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ª Generator å‡½æ•°çš„è‡ªåŠ¨æ‰§è¡Œå™¨æ¥è‡ªåŠ¨æ‰§è¡Œ Generator å‡½æ•°ã€‚å¦‚ä¸‹ï¼š

```js

function run(fn) {
    var gen = fn();

    function next(err, data) {
        var result = gen.next(data);
        if (result.done) {
            return;
        }
        result.value(next);
    }

    next();
}

function* g() {
    // ...
}

// æ‰§è¡Œ
run(g);
```